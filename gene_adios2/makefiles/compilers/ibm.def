# definitions for the IBM XL compilers

MPFC ?= mpixlf
MPCC ?= mpixlc
MPCXX ?= mpixlC
cmd=$(shell basename "`which $(MPFC)`")
ifneq ($(cmd),$(MPFC))
MPFC = mpif90
MPCC = mpicc
MPCXX=mpiCC
endif

#abort if no valid compiler is found
cmd=$(shell basename "`which $(MPFC)`")
ifneq ($(cmd),$(MPFC))
$(error $(MPFC) not found)
endif

FC = xlf2008_r
CC = xlc_r
CXX = xlC_r

MPFCVERSION:=$(shell $(FC) -qversion 2>&1 | head -1 | awk '{print $$6}')
MPFCMAJORVERSION:=$(shell echo $(MPFCVERSION) | awk -F. '{print $$1}')
MPFCMINORVERSION:=$(shell echo $(MPFCVERSION) | awk -F. '{print $$2}')

FFLAGS += -q64 -qextname

ifeq ($(USE_PERFLIB),perf)
ifeq ($(OPENMP),yes)
 LIBS += -L$(PERFLIB_HOME)/lib -looperf_mt -Wl,-rpath,$(PERFLIB_HOME)/lib
else
 LIBS += -L$(PERFLIB_HOME)/lib -looperf -Wl,-rpath,$(PERFLIB_HOME)/lib
endif
 PREPROC += -DWITHPERF=1
 INCPATHS += -I$(PERFLIB_HOME)/include
endif

#SET_F2003_STANDARD = -qlanglvl=2003std -qsuppress=1518-234
SET_FORTRAN_STANDARD = -qlanglvl=2008std -qsuppress=1518-234
#PREPROC_FLAG = -fpp
#ONLY_PREPROCESS = -EP
#HEAPARRAYS_FFLAGS = -heap-arrays 1024
#ALIGN_FFLAGS = -align array64byte

#DEBUG_TRACEBACK = -traceback
#DEBUG_WARN = -warn all
#DEBUG_RUNTIME_CHECK = -check all -ftrapuv -fstack-security-check -fpe0
#'-check noarg_temp_created' suppresses warnings about temporary arrays during runtime
#DEBUG_FFLAGS = $(DEBUG_TRACEBACK) -C -debug inline-debug-info
#DEBUG_FFLAGS += $(DEBUG_RUNTIME_CHECK) $(DEBUG_WARN)
#DEBUG_CFLAGS = $(DEBUG_TRACEBACK) -std=c99 -debug all -ftrapuv -w3 -Wall
#DEBUG_CXXFLAGS = $(DEBUG_TRACEBACK) -debug all -ftrapuv -w3 -Wall

CHIP_OPT ?= -qarch=pwr8
OPTLEVEL ?= 2

#reduce optimization in specific versions due to
#compiler bugs:
ifeq ($(findstring 12.1,$(MPFCVERSION)),12.1)
#OPTLEVEL = 2
endif

OPT_FFLAGS = -O$(OPTLEVEL) $(CHIP_OPT) -qmaxmem=-1
OPT_CFLAGS = -O$(OPTLEVEL) $(CHIP_OPT) -qmaxmem=-1
PRODRUN_FFLAGS = $(OPT_FFLAGS)
PRODRUN_CFLAGS = $(OPT_CFLAGS)
OPENMP_FFLAGS = -qsmp=omp -qthreaded
OPENMP_CFLAGS = -qsmp=omp -qthreaded

SYMBOL_FFLAGS += -g
SYMBOL_CFLAGS += -g

#REPORT_VEC_FFLAGS = -vec-report3
#REPORT_OPENMP_FFLAGS = -openmp-report2
#REPORT_OFFLOAD_FFLAGS = -opt-report-phase=offload
#REPORT_HLO_FFLAGS = -opt-report-phase=hlo
#REPORT_FFLAGS = -opt-report -opt-report-phase=all \
#	     -opt-report-file=gene_report.opt \
#	     $(REPORT_VEC_FFLAGS) $(REPORT_OPENMP_FFLAGS)

#REPORT_CFLAGS = $(REPORT_FFLAGS)

DOUBLE_PRECISION_FFLAGS = -qautodbl=dbl4 -qdpc=e
MODDIR_FFLAGS = -qmoddir=$(OBJDIR)

F2003_MISSING=

#reduce optimization in specific files and for specific compiler versions
#ifeq ($(MPFCMAJORVERSION),$(filter $(MPFCMAJORVERSION),12 13))
#NOOPTLIST += example_file.o
#NOOPTFLAGS = $(MODDIR_FFLAGS) -O0 $(DOUBLE_PRECISION_FFLAGS)
#endif
