# definitions for the Intel compilers

MPFC ?= mpiifort
MPCC ?= mpiicc
MPCXX ?= mpiicpc
cmd=$(shell basename "`which $(MPFC)`")
ifneq ($(cmd),$(MPFC))
MPFC = mpif90
MPCC = mpicc
MPCXX=mpiCC
endif
cmd=$(shell basename "`which $(MPFC)`")
ifneq ($(cmd),$(MPFC))
MPFC = mpif95
endif

#abort if no valid intel compiler is found
cmd=$(shell basename "`which $(MPFC)`")
ifneq ($(cmd),$(MPFC))
$(error $(MPFC) not found)
endif

FC = ifort
CC = icc
CXX = icpc

MPFCVERSION:=$(shell $(FC) --version 2>&1 | head -1 | awk '{print $$3}')
MPFCMAJORVERSION:=$(shell echo $(MPFCVERSION) | awk -F. '{print $$1}')
MPFCMINORVERSION:=$(shell echo $(MPFCVERSION) | awk -F. '{print $$2}')

ifeq ($(USE_PERFLIB),scalasca)
 MPFC = scorep mpiifort
 MPCC = scorep  mpiicc
 MPCXX = scorep  mpiicpc
#	FFLAGS += -fpp -Wp,-P
endif
ifeq ($(USE_PERFLIB),ompp)
# the preprocessor must not write #line directives
# and also the quotes in the SVN statement is switched off
 MPFC = kinst-ompp mpiifort
 FC = kinst-ompp ifort
#	FFLAGS += -fpp -Wp,-P
endif

ifeq ($(USE_PERFLIB),likwid)
 LIBS += -L$(LIKWID_HOME)/lib -llikwid -Wl,-rpath,$(LIKWID_HOME)/lib
 PREPROC += -DWITH_LIKWID
 INCPATHS += -I$(LIKWID_HOME)/include
endif

ifeq ($(USE_PERFLIB),perf)
ifeq ($(OPENMP),yes)
 LIBS += -L$(PERFLIB_HOME)/lib -looperf_mt -Wl,-rpath,$(PERFLIB_HOME)/lib
else
 LIBS += -L$(PERFLIB_HOME)/lib -looperf -Wl,-rpath,$(PERFLIB_HOME)/lib
endif
 PREPROC += -DWITHPERF=1
 INCPATHS += -I$(PERFLIB_HOME)/include
endif

ifeq ($(USE_PERFLIB),vtune)
 PREPROC += -DWITH_VTUNE_API
 INCPATHS += -I$(VTUNE_HOME)/include
 LIBS += -L$(VTUNE_HOME)/lib64 -littnotify
endif

ifeq ($(USE_PERFLIB),vtrace)
 FFLAGS += -tcollect
 LDFLAGS += -tcollect
 INCPATHS += -I$(ITAC_HOME)/include
endif

ifeq ($(USE_PERFLIB),coverage)
 FFLAGS += -prof-gen=srcpos
endif

SET_FORTRAN_STANDARD = -stand f08 -diag-disable 7416,7025,10121
PREPROC_FLAG = -fpp
ONLY_PREPROCESS = -EP
HEAPARRAYS_FFLAGS = -heap-arrays 1024
ALIGN_FFLAGS = -align array64byte

DEBUG_TRACEBACK = -traceback
DEBUG_WARN = -warn all
DEBUG_RUNTIME_CHECK = -check all -ftrapuv -fstack-security-check -fpe0
#'-check noarg_temp_created' suppresses warnings about temporary arrays during runtime
DEBUG_FFLAGS = $(DEBUG_TRACEBACK) -C -debug inline-debug-info
DEBUG_FFLAGS += $(DEBUG_RUNTIME_CHECK) $(DEBUG_WARN)
DEBUG_CFLAGS = $(DEBUG_TRACEBACK) -std=c99 -debug all -ftrapuv -w3 -Wall
DEBUG_CXXFLAGS = $(DEBUG_TRACEBACK) -debug all -ftrapuv -w3 -Wall

ifeq ($(CHIP),native)
 CHIP_OPT = -march=native
endif
ifeq ($(CHIP),Core2)
 CHIP_OPT = -march=core2 -xSSSE3
endif
ifeq ($(CHIP),Magny-Cours)
 CHIP_OPT = -msse3
endif
ifeq ($(CHIP),Nehalem)
 CHIP_OPT = -march=corei7 -xSSE4.2
endif
ifeq ($(CHIP),SandyBridge)
 CHIP_OPT = -march=corei7-avx -xAVX
endif
ifeq ($(CHIP),Xeon_E5_IvyBridge)
 CHIP_OPT = -march=core-avx-i -xAVX
endif
ifeq ($(CHIP),IvyBridge)
 CHIP_OPT = -march=core-avx-i -xcore-avx-i
endif
ifeq ($(CHIP),haswell)
 CHIP = Haswell
endif
ifeq ($(CHIP),Haswell)
#requires intel version >=13
 CHIP_OPT = -march=core-avx2 -xcore-avx2 $(ALIGN_FFLAGS)
endif
ifeq ($(CHIP),Broadwell)
 CHIP_OPT = -march=core-avx2 -xcore-avx2 $(ALIGN_FFLAGS)
endif
ifeq ($(CHIP),Phi)
 CHIP_OPT =
 MKL_ARCH = mic
endif
ifeq ($(CHIP),mic-knl)
 CHIP = KnightsLanding
endif
ifeq ($(CHIP),KnightsLanding)
 CHIP_OPT = -axMIC-AVX512 $(ALIGN_FFLAGS)
endif
ifeq ($(CHIP),skylake)
 CHIP = SkyLake
endif
ifeq ($(CHIP),SkyLake)
 CHIP_OPT = -xCORE-AVX512 -mtune=skylake $(ALIGN_FFLAGS)
endif
ifeq ($(CHIP),None)
 CHIP_OPT =
endif

CHIP_OPT ?= -march=native
OPTLEVEL ?= 3

#reduce optimization in specific versions due to
#compiler bugs:
ifeq ($(findstring 12.1,$(MPFCVERSION)),12.1)
#OPTLEVEL = 2
endif

OPT_FFLAGS = -O$(OPTLEVEL) $(CHIP_OPT)
OPT_CFLAGS = -O$(OPTLEVEL) $(CHIP_OPT)
PRODRUN_FFLAGS = $(OPT_FFLAGS) -ip
PRODRUN_CFLAGS = $(OPT_CFLAGS) -ip

SYMBOL_FFLAGS += -g
SYMBOL_CFLAGS += -g

ifeq ($(findstring 18,$(MPFCVERSION)),18)
OPENMP_FFLAGS = -qopenmp
OPENMP_CFLAGS = -qopenmp
else
OPENMP_FFLAGS = -openmp
OPENMP_CFLAGS = -openmp
endif


REPORT_VEC_FFLAGS = -vec-report3
ifeq ($(findstring 18,$(MPFCVERSION)),18)
REPORT_OPENMP_FFLAGS = -qopenmp-report2
REPORT_OFFLOAD_FFLAGS = -qopt-report-phase=offload
REPORT_HLO_FFLAGS = -qopt-report-phase=hlo
REPORT_FFLAGS = -qopt-report -qopt-report-phase=all \
	     -qopt-report-file=gene_report.opt \
	     $(REPORT_VEC_FFLAGS) $(REPORT_OPENMP_FFLAGS)
else
REPORT_OPENMP_FFLAGS = -openmp-report2
REPORT_OFFLOAD_FFLAGS = -opt-report-phase=offload
REPORT_HLO_FFLAGS = -opt-report-phase=hlo
REPORT_FFLAGS = -opt-report -opt-report-phase=all \
	     -opt-report-file=gene_report.opt \
	     $(REPORT_VEC_FFLAGS) $(REPORT_OPENMP_FFLAGS)
endif

REPORT_CFLAGS = $(REPORT_FFLAGS)

DOUBLE_PRECISION_FFLAGS = -r8
MODDIR_FFLAGS = -module $(OBJDIR)

F2003_MISSING=

ifeq ($(findstring 13.1,$(MPFCVERSION)),13.1)
F2003_MISSING += -DF2003_NO_OPEN_CONVERT
endif

#reduce optimization in specific files and for specific compiler versions
#ifeq ($(MPFCMAJORVERSION),$(filter $(MPFCMAJORVERSION),12 13))
#NOOPTLIST += example_file.o
#NOOPTFLAGS = $(MODDIR_FFLAGS) -O0 $(DOUBLE_PRECISION_FFLAGS)
#endif
